<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Chat</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6fa; margin: 0; padding: 0; }
    .container { max-width: 600px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 24px; }
    h2 { text-align: center; margin-bottom: 16px; }
    .room-controls { display: flex; gap: 8px; margin-bottom: 16px; }
    #rooms { flex: 1; padding: 6px; border-radius: 4px; border: 1px solid #ccc; }
    #joinBtn, #leaveBtn { padding: 6px 12px; border-radius: 4px; border: none; background: #007bff; color: #fff; cursor: pointer; }
    #leaveBtn { background: #dc3545; }
    #joinBtn:disabled, #leaveBtn:disabled { background: #aaa; cursor: not-allowed; }
    .user-controls { display: flex; gap: 8px; margin-bottom: 16px; }
    #sender, #text { flex: 1; padding: 6px; border-radius: 4px; border: 1px solid #ccc; }
    #sendBtn { padding: 6px 12px; border-radius: 4px; border: none; background: #28a745; color: #fff; cursor: pointer; }
    #sendBtn:disabled { background: #aaa; cursor: not-allowed; }
    #messages { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; background: #f8f9fa; border-radius: 4px; border: 1px solid #eee; }
    #messages li { padding: 6px 10px; border-bottom: 1px solid #eee; }
    #messages li:last-child { border-bottom: none; }
    .status { text-align: center; margin-bottom: 12px; color: #555; font-size: 0.95em; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Chatroom</h2>
    <div class="room-controls">
      <select id="rooms"></select>
      <button id="joinBtn">Join Room</button>
      <button id="leaveBtn">Leave Room</button>
      <input id="newRoomName" placeholder="New room name" style="flex:1;" />
      <button id="addRoomBtn">Add Room</button>
      <button id="deleteRoomBtn">Delete Room</button>
    </div>
    <div class="status" id="status"></div>
    <div class="current-room" id="currentRoom" style="text-align:center; font-weight:bold; margin-bottom:10px;"></div>
    <div class="user-controls" id="userControls">
      <input id="sender" placeholder="Your name"/>
      <input id="text" placeholder="Message"/>
      <button id="sendBtn">Send</button>
    </div>
    <ul id="messages"></ul>
  </div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    const api = 'http://localhost:3000';
    const socket = io(api);

    const roomsSelect = document.getElementById('rooms');
    const messagesEl = document.getElementById('messages');

    let joinedRoomId = null;
    const statusEl = document.getElementById('status');
    const joinBtn = document.getElementById('joinBtn');
    const leaveBtn = document.getElementById('leaveBtn');
    const sendBtn = document.getElementById('sendBtn');
    const userControls = document.getElementById('userControls');
    const currentRoomEl = document.getElementById('currentRoom');
    const addRoomBtn = document.getElementById('addRoomBtn');
    const deleteRoomBtn = document.getElementById('deleteRoomBtn');
    const newRoomNameInput = document.getElementById('newRoomName');

    async function loadRooms(){
      const res = await fetch(api + '/chatrooms');
      const rooms = await res.json();
      roomsSelect.innerHTML = rooms.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
      if (rooms.length && !joinedRoomId) {
        statusEl.textContent = 'Select a room and click Join.';
        currentRoomEl.textContent = '';
      }
      // If joined room was deleted, leave it
      if (joinedRoomId && !rooms.find(r => String(r.id) === String(joinedRoomId))) {
        leaveBtn.onclick();
      }
    }

    async function loadMessages(roomId){
      const res = await fetch(api + '/messages/' + roomId);
      const msgs = await res.json();
      messagesEl.innerHTML = msgs.map(m => `<li><span style='color:#888'>${new Date(m.createdAt).toLocaleTimeString()}</span> <b>${m.sender}</b>: ${m.text}</li>`).join('');
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    joinBtn.onclick = () => {
      const roomId = roomsSelect.value;
      const roomName = roomsSelect.options[roomsSelect.selectedIndex]?.text || '';
      if (joinedRoomId) {
        socket.emit('leaveRoom', { roomId: joinedRoomId });
      }
      socket.emit('joinRoom', { roomId });
      joinedRoomId = roomId;
      loadMessages(roomId);
      statusEl.textContent = `Joined room: ${roomName}`;
      currentRoomEl.textContent = `Current Room: ${roomName}`;
      joinBtn.disabled = true;
      leaveBtn.disabled = false;
      sendBtn.disabled = false;
      userControls.style.display = '';
    };

    leaveBtn.onclick = () => {
      if (joinedRoomId) {
        socket.emit('leaveRoom', { roomId: joinedRoomId });
        statusEl.textContent = 'Left room.';
        currentRoomEl.textContent = '';
        joinedRoomId = null;
        messagesEl.innerHTML = '';
        joinBtn.disabled = false;
        leaveBtn.disabled = true;
        sendBtn.disabled = true;
        userControls.style.display = 'none';
      }
    };
    addRoomBtn.onclick = async () => {
      const name = newRoomNameInput.value.trim();
      if (!name) {
        statusEl.textContent = 'Enter a room name.';
        return;
      }
      try {
        const res = await fetch(api + '/chatrooms', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        if (res.ok) {
          statusEl.textContent = `Room "${name}" added.`;
          newRoomNameInput.value = '';
          await loadRooms();
        } else {
          statusEl.textContent = 'Failed to add room.';
        }
      } catch {
        statusEl.textContent = 'Error adding room.';
      }
    };

    deleteRoomBtn.onclick = async () => {
      const roomId = roomsSelect.value;
      const roomName = roomsSelect.options[roomsSelect.selectedIndex]?.text || '';
      if (!roomId) {
        statusEl.textContent = 'Select a room to delete.';
        return;
      }
      if (!confirm(`Are you sure you want to delete the room "${roomName}"? This will also delete all its messages.`)) return;
      // If currently joined, leave first
      if (joinedRoomId && String(joinedRoomId) === String(roomId)) {
        leaveBtn.onclick();
      }
      try {
        const res = await fetch(api + '/chatrooms/' + roomId, {
          method: 'DELETE'
        });
        if (res.ok) {
          statusEl.textContent = 'Room deleted.';
          await loadRooms();
        } else {
          statusEl.textContent = 'Failed to delete room.';
        }
      } catch {
        statusEl.textContent = 'Error deleting room.';
      }
    };

    socket.on('newMessage', m => {
      if (joinedRoomId && String(m.roomId) === String(joinedRoomId)) {
        messagesEl.innerHTML += `<li><span style='color:#888'>${new Date(m.createdAt).toLocaleTimeString()}</span> <b>${m.sender}</b>: ${m.text}</li>`;
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }
    });

    socket.on('joinedRoom', data => {
      const roomName = roomsSelect.options[roomsSelect.selectedIndex]?.text || '';
      statusEl.textContent = `Successfully joined room: ${roomName}`;
      currentRoomEl.textContent = `Current Room: ${roomName}`;
    });
    socket.on('leftRoom', data => {
      statusEl.textContent = `Left room.`;
      currentRoomEl.textContent = '';
    });
    socket.on('error', err => {
      statusEl.textContent = err.message;
    });

    sendBtn.onclick = async () => {
      if (!joinedRoomId) {
        statusEl.textContent = 'Join a room first!';
        return;
      }
      const roomId = Number(joinedRoomId);
      const sender = document.getElementById('sender').value || 'Anon';
      const text = document.getElementById('text').value;
      if (!text.trim()) return;
      socket.emit('sendMessage', { roomId, sender, text });
      document.getElementById('text').value = '';
    };

    roomsSelect.onchange = () => {
      if (joinedRoomId) loadMessages(roomsSelect.value);
    };

    // Initial state
    joinBtn.disabled = false;
    leaveBtn.disabled = true;
    sendBtn.disabled = true;
    userControls.style.display = 'none';
    loadRooms();
  </script>
</body>
</html>
